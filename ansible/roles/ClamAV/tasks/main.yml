- name: Update apt cache
  become: true
  apt:
    update_cache: yes

- name: Install ClamAV
  become: true
  apt:
    name:
      - clamav
      - clamav-daemon
    state: present

- name: Stop ClamAV service
  become: true
  service:
    name: clamav-freshclam
    state: stopped

- name: Edit ClamAV configuration file
  become: true
  vars:
    clamav_config_file: "/etc/clamav/clamd.conf"
    scan_directory: "/"
  tasks:
    - name: Uncomment OnAccessIncludePath line
      lineinfile:
        path: "{{ clamav_config_file }}"
        regexp: "^#OnAccessIncludePath"
        line: "OnAccessIncludePath {{ scan_directory }}"
        state: present
        backup: yes

- name: Add ScanOnAccess and OnAccessPrevention lines
  blockinfile:
    path: "{{ clamav_config_file }}"
    block: |
      OnAccessPrevention yes
      ScanOnAccess yes
    backup: yes

- name: Update the ClamAV signature database
  become: true
  command: freshclam

- name: Configure ClamAV user
  become: true
  lineinfile:
    path: "/etc/systemd/system/multi-user.target.wants/clamav-daemon.service"
    regexp: "^User=clamav"
    line: "User=root"
    state: present

- name: Restart ClamAV service
  become: true
  service:
    name: clamav-freshclam
    state: restarted
    enabled: true

- name: Start ClamAV service
  become: true
  service:
    name: clamav-freshclam
    state: started
    enabled: true

- name: Enable ClamAV daemon
  become: true
  service:
    name: clamav-daemon
    enabled: yes
